- dvars = { 'daily' => [], 'hourly' => [] }
- mindate = @sites.first.try(:[], 'begin_date')
- maxdate = @sites.first.try(:[], 'end_date')

= form_for @export, remote: true do |f|
  .tab-content
    #site-list.tab-pane.active
      .list{ style: 'max-height: 500px; overflow: auto;' }
        %table.table
          %thead
            %tr
              %th
                = check_box_tag :select_all, 1, true, data: { toggle: 'checkboxes', target: '.site_ids' }
              %th Site name
              %th Location
              %th Start Date
              %th End Date
              %th Geophysical Parameters
          %tbody
            - @sites.each do |site|
              - dvars['daily'] += site['derived_variables']['daily']
              - dvars['hourly'] += site['derived_variables']['hourly']
              - mindate = site['begin_date'] if mindate > site['begin_date']
              - maxdate = site['end_date'] if maxdate < site['end_date']
              %tr
                %td
                  = check_box_tag "export[sites][]", site['siteid'], true, class: 'site_ids'
                %td
                  %abbr{ title: site['sitename'] }
                    = truncate(site['sitename'], length: 25, omission: '...')
                %td
                  %nobr= format_geolocation(site['geolocation'])
                %td= site['begin_date'] if site['begin_date'].present?
                %td= site['end_date'] if site['end_date'].present?
                %td= site['derived_variables'].try(:join, ', ')
      .text-right{ style: 'padding:10px; border-top: 1px solid #efefef;' }
        %a.btn.btn-primary{ href: '#export-options', data: { toggle: 'tab' } }
          Next
          %i.glyphicon.glyphicon-arrow-right
    #export-options.tab-pane
      .form-content{ style: 'padding:10px;' }
        .form-group
          .row
            .col-lg-2.col-md-2.col-sm-12
              .form-group
                = f.label :starts_at, class: 'control-label'
                = f.text_field :starts_at, class: 'form-control datepicker', placeholder: 'YYYY/MM/DD'
            .col-lg-2.col-md-2.col-sm-12
              .form-group
                = f.label :ends_at, class: 'control-label'
                = f.text_field :ends_at, class: 'form-control datepicker', placeholder: 'YYYY/MM/DD'
        .form-group
          %label Geophysical Parameters
          %ul.nav.nav-tabs
            - dvars.each do |timestep, items|
              %li{ class: timestep == 'daily' ? 'active' : '' }
                %a{ href: "##{timestep}_fields", data: { toggle: 'tab' } }= timestep.capitalize
          #export_fields.tab-content
            - dvars.each do |timestep, items|
              .tab-pane{ id: "#{timestep}_fields", class: timestep == 'daily' ? 'active' : '' }
                .form-group
                  - items.uniq.sort.each do |variable|
                    .checkbox
                      %label
                        = check_box :export, :variables, { multiple: true, class: 'export_variable'}, variable.last, nil
                        = variable.first
      .text-left{ style: 'padding:10px; border-top: 1px solid #efefef;' }
        %a.btn.btn-primary{ href: '#site-list', data: { toggle: "tab" } }
          %i.glyphicon.glyphicon-arrow-left
          Back
        %a.btn.btn-primary.pull-right{ href: '#notification-options', data: { toggle: 'tab' } }
          Next
          %i.glyphicon.glyphicon-arrow-right
    #notification-options.tab-pane
      .form-content{ style: 'padding:10px;' }
        .form-group
          %label Export Instructions
          %p
            The export process is still in development and not currently available to the public.
          %p
            Imiq hydroclimate database questions?
            Please contact
            = mail_to 'imiq@arcticlcc.org', 'imiq@arcticlcc.org'
        .form-group
          = f.label :email, class: 'control-label'
          = f.text_field :email, class: 'form-control', placeholder: 'Email address'
      .text-left{ style: 'padding:10px; border-top: 1px solid #efefef;' }
        %a.btn.btn-primary{ href: '#export-options', data: { toggle: "tab" } }
          %i.glyphicon.glyphicon-arrow-left
          Back
        = f.submit 'Export', class: 'btn btn-primary pull-right'
:javascript
  $('.datepicker').datepicker({
    startDate: "#{mindate}",
    endDate: "#{maxdate}",
    autoclose: true,
    todayHighlight: true,
    forceParse: false,
    format: 'yyyy/mm/dd'
  });
