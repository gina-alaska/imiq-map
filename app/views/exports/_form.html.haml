- dvars = []
- mindate = @sites.first.try(:[], 'begin_date')
- maxdate = @sites.first.try(:[], 'end_date')

= form_for @export do |f|
  .tab-content
    #site-list.tab-pane.active
      .list{ style: 'max-height: 500px; overflow: auto;' }
        %table.table
          %thead
            %tr
              %th
                = check_box_tag :select_all, 1, true, data: { toggle: 'checkboxes', target: '.site_ids' }
              %th Site name
              %th Location
              %th Start Date
              %th End Date
              %th Geophysical Parameters
          %tbody
            - @sites.each do |site|
              - dvars += site['derived_variables']
              - mindate = site['begin_date'] if mindate > site['begin_date']
              - maxdate = site['end_date'] if maxdate < site['end_date']
              %tr
                %td
                  = check_box_tag "export[sites][]", site['siteid'], true, class: 'site_ids'
                %td
                  %abbr{ title: site['sitename'] }
                    = truncate(site['sitename'], length: 25, omission: '...')
                %td
                  %nobr= format_geolocation(site['geolocation'])
                %td= site['begin_date'] if site['begin_date'].present?
                %td= site['end_date'] if site['end_date'].present?
                %td= site['derived_variables'].try(:join, ', ')
      .text-right{ style: 'padding:10px; border-top: 1px solid #efefef;' }
        %a.btn.btn-primary{ href: '#export-options', data: { toggle: 'tab' } }
          Next
          %i.glyphicon.glyphicon-arrow-right
    #export-options.tab-pane
      .form-content{ style: 'padding:10px;' }
        .form-group
          .row
            .col-lg-2.col-md-2.col-sm-12
              .form-group
                = f.label :starts_at, class: 'control-label'
                = f.text_field :starts_at, class: 'form-control datepicker', placeholder: 'YYYY/MM/DD'
            .col-lg-2.col-md-2.col-sm-12
              .form-group
                = f.label :ends_at, class: 'control-label'
                = f.text_field :ends_at, class: 'form-control datepicker', placeholder: 'YYYY/MM/DD'
        .form-group
          %label Timestep
          - timesteps.each do |timestep|
            .radio
              %label
                = f.radio_button :timestep, timestep[1], { checked: timestep == timesteps.first, class: 'export_timestep' }
                = timestep[0]
        .form-group
          %label Geogphysical Parameters
          - dvars.uniq!
          - dvars.each do |variable|
            .checkbox
              %label
                = check_box :export, :variables, { multiple: true, class: 'export_variable'}, variable.downcase.gsub(/\s+/, '_'), nil
                = variable
      .text-left{ style: 'padding:10px; border-top: 1px solid #efefef;' }
        %a.btn.btn-primary{ href: '#site-list', data: { toggle: "tab" } }
          %i.glyphicon.glyphicon-arrow-left
          Back
        = f.submit 'Export', class: 'btn btn-primary pull-right'
:javascript
  $('.datepicker').datepicker({
    startDate: "#{mindate}",
    endDate: "#{maxdate}",
    autoclose: true,
    todayHighlight: true,
    forceParse: false,
    format: 'yyyy/mm/dd'
  });

  var selected_timestep = $('#time_step option:selected').val();
  if (selected_timestep.toLowerCase() != 'any') {
    $('.export_timestep[value="'+ selected_timestep  +'"]').click();
  }
  var selected_variable = $('#variablename option:selected').val();
  if (selected_variable.toLowerCase() != 'any') {
    $('.export_variable[value="'+ selected_variable +'"]').click();
  }
